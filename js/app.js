var museumApp=function(){"use strict";var e={},o={ready:!1,makingDefaultPlaces:!0},a=!1,t=[{name:"City of Bristol, UK",location:{lat:51.454513,lng:-2.5879099999999653}},{name:"Worcester, Worcester, UK",location:{lat:52.193636,lng:-2.22157500000003}},{name:"Leicester Square, London, UK",location:{lat:51.5102585,lng:-.1308881999999585}},{name:"Broekwijk, Brussel, Belgium",location:{lat:50.851645,lng:4.357623200000035}},{name:"SÃ¨vres, Hauts-de-Seine Ile-de-France",location:{lat:48.824329,lng:2.21212}}],r=function(){var e=!!function(){var e,o=+new Date;try{return localStorage.setItem(o,o),e=localStorage.getItem(o)==o,localStorage.removeItem(o),e}catch(a){}}()&&localStorage;return e},s=function(){if(museumApp.localStorageP()&&void 0!==museumApp.museumData.data)museumApp.museumViewModel.vm.mapHelpers.rebuildMarkersFromMusuemData(),o.makingDefaultPlaces=!1;else{var e=t;console.log("first time app run or no local storage"),l(e)}},l=function(e){if(e.length>0)for(var o=0;o<e.length;o++)museumApp.museumViewModel.vm.mapHelpers.searchHere(e[o].location)},n=function(e){var o="";o+='<section class="ui negative large message">',o+='<i class="large orange bug icon"></i>',o+="<h3>Sorry, failed to get "+e+"</span></h3>",o+="<p>Refresh the browser page or try again later ...</p>",o+="</section>",museumApp.googleFail=o,ko.applyBindings()},u=function(){r()&&localStorage.museumDataStored&&(e.data=JSON.parse(localStorage.museumDataStored)),ko.options.deferUpdates=!0;var a=new g;o.vm=a,ko.applyBindings(o.vm),o.ready=!0,s(),$("#loadingArea").hide("slow"),$("body").removeClass("initial-hide"),window.addEventListener("resize",function(){o.vm.mapHelpers.zoomToAllPlaces()})},i=function(e,a,r){var s=$.ajax({url:a.url,type:"GET",data:a.search_parameters,dataType:a.dataType,timeout:1e4});s.done(function(e,s,l){if(a.isLoaded="loaded","json"===a.dataType){var n={},u=a.modelCollection;if("place"===u){var i=e.records;if(0===i.length){var m=r.prefPlaceMarker.labelContent;museumApp.museumViewModel.vm.uiModel.obsUIerrorHtml("<span>sorry no musuem object places found at <em>"+m+"</em></span>");var d=1800,g=function(){clearTimeout(g),museumApp.museumViewModel.vm.mapHelpers.removeMarker(r)};return setTimeout(g,d),!1}var b=i.filter(function(e){return e.fields.museumobject_count>0});if(i.length!==b.length&&(e.meta.result_count=b.length,e.records=b),n={googlePlace:r.bestPlace,resourceRefObj:a,museumCollectionType:a.modelCollection,museumData:e},c(u,e,r),o.makingDefaultPlaces){var f=museumApp.museumViewModel.vm.mapsModel.obsArrayMapMarkers().length,M=t.length;f>M&&(o.makingDefaultPlaces=!1,museumApp.museumViewModel.vm.uiModel.obsSelectedMusuemMarker(r))}else museumApp.museumViewModel.vm.museumDataHelpers.clearSelectedMusuemMarker(),museumApp.museumViewModel.vm.uiModel.obsSelectedMusuemMarker(r)}else if("placeObjects"===u){museumApp.museumViewModel.vm.museumDataHelpers.setThumbImagePath(e),n={resourceRefObj:a,museumCollectionType:a.modelCollection,museumData:e};var v=e.records;museumApp.museumViewModel.vm.uiModel.obsCurrentMuseumObjects(v)}else if("objectDetails"===u){var k=e[0],h=k.fields.image_set,P=h.filter(function(e){return e.fields.local.length>0});e[0].fields.image_set=P,museumApp.museumViewModel.vm.uiModel.obsSelectedMusuemObject(k),n={resourceRefObj:a,museumCollectionType:a.modelCollection,museumData:k}}p(n)}}),s.fail(function(e,o,t){if("json"===a.dataType){museumApp.museumViewModel.vm.mapsModel.googleMap.setZoom(2);var r="Sorry, cannot get V&A museum "+a.modelCollection+" data",s="",l='<div class="container" width="180" height="230">';l+='   <div class="ui segment">',l+='    <div class="ui header">',l+='     <div class="ui tiny image">',l+='      <img src="img/VA_logo.png"></div>',l+='      <div class="segment">',l+="        <h3>"+a.name+"</h3>",l+="        <p>"+r+"</p>",l+="        <p>"+s+"</p>",l+="      </div>",l+="    </div>",l+="  </div>",l+="  </div>",museumApp.museumViewModel.vm.mapHelpers.openInfoBoxWithError(l)}}),s.always(function(e,o,a){})},c=function(e,o,a){a.VaM().hasOwnProperty[e]?a.VaM()[e].push(o):(a.VaM()[e]=ko.observableArray([]),a.VaM()[e].subscribe(function(e){var o=a.VaM().place()[0],t=+o.meta.result_count,r=o.records.length,s="";if(0===t){var l=a.prefPlaceMarker.labelContent;museumApp.museumViewModel.vm.uiModel.obsUIerrorHtml("<span>sorry no musuem object places found at <em>"+l+"</em></span>");var n=2100,u=function(){clearTimeout(u),museumApp.museumViewModel.vm.mapHelpers.removeMarker(a)};return setTimeout(u,n),!1}r===t?s=r+" museum object place":1===r?s=r+" museum object place":r>1&&(s=r+" of "+t+" museum object place"),t>1&&(s+="s"),a.obsMuseumMarkerListLabel(s)}),a.VaM()[e].push(o))},m=function(e){var o=new Uint8Array((e||40)/2);return window.crypto.getRandomValues(o),[].map.call(o,function(e){return e.toString(16)}).join("")},p=function(o){var a=o.resourceRefObj,t=a.modelCollection,r="unknown_"+m(20);if("place"===t?r=a.placeID:"placeObjects"===t?r=a.search_parameters.place.toString():"objectDetails"===t&&(r=o.museumData.pk.toString()),e.data||(e.data={}),e.data.hasOwnProperty(t)||(e.data[t]={}),e.data[t].hasOwnProperty(r)&&a.search_parameters.hasOwnProperty("offset"))for(var s=e.data[t][r].museumData.records,l=o.museumData,n=0;n<s.length;n++)l.records.unshift(s[n]);e.data[t][r]=o,d()},d=function(){r()&&(localStorage.museumDataStored?localStorage.museumDataStored=JSON.stringify(e.data):(localStorage.museumDataStored={},localStorage.museumDataStored=JSON.stringify(e.data)))},g=function(){var o={placeTypeInPrefOrder:["neighborhood","locality","political","administrative_area_level_4","administrative_area_level_3","postal_town"],obsArrayMapMarkers:ko.observableArray([]),obsUserLocalPlace:ko.observable(!1),obsFilterSearch:ko.observable(""),obsSelectedPlace:ko.observable(!1)};o.compFilterMapList=ko.computed(function(){var e=o.obsFilterSearch().toLowerCase();return""===e?o.obsArrayMapMarkers():ko.utils.arrayFilter(o.obsArrayMapMarkers(),function(o){var a=o.bestPlace.formatted_address.toLowerCase(),t=a.indexOf(e);return t>=0})}),o.compSortedMapMarkers=ko.computed(function(){var e=o.compFilterMapList();if(e.length>1){var a=e.sort(function(e,o){var a="";a="street_number"===e.bestPlace.address_components[0].types[0]?e.bestPlace.address_components[1].long_name.split(" ")[0].toLowerCase():e.bestPlace.address_components[0].long_name.split(" ")[0].toLowerCase();var t="";return t="street_number"===o.bestPlace.address_components[0].types[0]?o.bestPlace.address_components[1].long_name.split(" ")[0].toLowerCase():o.bestPlace.address_components[0].long_name.split(" ")[0].toLowerCase(),a===t?0:t>a?-1:1});return a}return e});var a={obsUIerrorHtml:ko.observable(!1),appUIWarnTimeOutID:!1,musemObjectWindow:new InfoBox({boxClass:"musuemobject-infoBox",content:"",disableAutoPan:!1,pixelOffset:new google.maps.Size(-150,28),zIndex:null,closeBoxURL:"",closeBoxMargin:""}),obsHelpVisible:ko.observable(!0),obsMusemObjectWindowVisible:ko.observable(!1),obsSelectedMusuemMarker:ko.observable(!1),obsSelectedMusuemObjectPlace:ko.observable(!1),obsSelectedMusuemObject:ko.observable(!1),obsCurrentPlaceObjects:ko.observableArray([]),obsCurrentMuseumObjects:ko.observableArray([])};a.compShowMusuemMarkersList=ko.computed(function(){return!a.obsSelectedMusuemMarker()}),a.compShowMusuemPlaceList=ko.computed(function(){return a.compShowMusuemMarkersList()?!1:a.obsCurrentPlaceObjects()===!1?(t.clearSelectedMusuemMarker(),!1):!a.obsSelectedMusuemObjectPlace()}),a.compShowMusuemObjectsList=ko.computed(function(){return a.obsSelectedMusuemObjectPlace()?!a.obsSelectedMusuemObject():!1}),a.compMuseumMarkerCrumb=ko.computed(function(){return a.obsSelectedMusuemMarker()?a.obsSelectedMusuemMarker().prefPlaceMarker.labelContent:""}),a.compObjectPlaceCrumb=ko.computed(function(){if(a.obsSelectedMusuemObjectPlace()){if(0===a.obsCurrentMuseumObjects().length)return"";var e=a.obsSelectedMusuemObjectPlace().fields.name;return e}return""}),a.compMusuemObjectCrumb=ko.computed(function(){if(a.obsSelectedMusuemObject()){var e=a.obsSelectedMusuemObject().fields,o=e.title;return""===o&&(o=e.object),o+=", "+e.date_text}return""}),a.compNumOfFilteredPlaces=ko.computed(function(){var e=o.compFilterMapList().length,a=o.obsArrayMapMarkers().length,t=e+" filtered place";return 0===e?t="no places":e===a?t="All places":e>1&&(t+="s"),t}),a.compFilterButtonLabel=ko.computed(function(){var e=o.compFilterMapList().length,a=o.obsArrayMapMarkers().length;return e===a?"Filter "+a+" places":"Clear Filter"}),a.compFilterLabelText=ko.computed(function(){var e=o.compFilterMapList().length,a=o.obsArrayMapMarkers().length;return e===a?"all places":0===e?"no places":e+" of "+a+" places"});var t=function(){var t=function(e){for(var o=e.records,a=0;a<o.length;a++){var t=o[a];if(t.fields.primary_image_id.length>0){var r="http://media.vam.ac.uk/media/thira/collection_images/",s=t.fields.primary_image_id,l=s.substring(0,6),n=r+l+"/"+s+"_jpg_s.jpg";t.imgURL=n}else t.imgURL="img/VandA_logo70x70.png"}},l=function(){u(),n(),a.obsCurrentPlaceObjects(!1),a.obsSelectedMusuemMarker(!1)},n=function(){u(),a.obsSelectedMusuemObjectPlace(!1),a.obsCurrentMuseumObjects(!1)},u=function(){s.closeMuseumObjectWindow(),a.obsMusemObjectWindowVisible(!1),a.obsSelectedMusuemObject(!1)},c=function(o){var a=o.bestPlace.place_id,t=museumApp.museumData.data.place;delete t[a],r()&&(localStorage.museumDataStored?localStorage.museumDataStored=JSON.stringify(e.data):(localStorage.museumDataStored={},localStorage.museumDataStored=JSON.stringify(e.data)))},m=function(){o.obsFilterSearch("")},p=function(e,o,t){var r=e.bestPlace,l="V&A collection place name search for museumobjects: "+r.address_components[0].short_name,n=r.geometry.location,u={placeLoc:n,placeID:r.place_id,placeName:r.address_components[0].short_name,name:l,modelCollection:"place",dataType:"json",search_parameters:{latitude:r.geometry.location.lat,longitude:r.geometry.location.lng,orderby:"distance",radius:o,limit:45},url:"http://www.vam.ac.uk/api/json/place/search",isLoaded:"no"};t&&(u.search_parameters.offset=t);var c=M(u.modelCollection,u.placeID);if(c!==!1)a.obsCurrentPlaceObjects(c),a.obsSelectedMusuemMarker(e),s.panMapToMuseumMarker(e);else{var m=0;i(m,u,e)}},d=ko.computed(function(){if(a.obsSelectedMusuemObjectPlace()){var e=a.obsSelectedMusuemObjectPlace(),o=+e.fields.museumobject_count,t=a.obsCurrentMuseumObjects().length;return void 0!==t?o>t:!1}return!1}),g=function(){if(a.obsSelectedMusuemObjectPlace()){var e=a.obsSelectedMusuemObjectPlace().pk;b(e,a.obsSelectedMusuemMarker())}},b=function(e,o){var t=0,r="V&A - museum placeObjects for collection.place - pk: "+e,s={name:r,modelCollection:"placeObjects",dataType:"json",search_parameters:{place:e,limit:45},url:"http://www.vam.ac.uk/api/json/museumobject/",isLoaded:"no"},l=M(s.modelCollection,e);if(l){var n=l.museumData.meta.result_count,u=l.museumData.records;if(u.length<n){var c=u.length;s.search_parameters.offset=c,i(t,s,o)}else a.obsCurrentMuseumObjects(l.museumData.records)}else i(t,s,o)},f=function(e){var o=0,a="V&A - museum object details:  "+e,t={name:a,modelCollection:"objectDetails",dataType:"json",search_parameters:{object_number:e},url:"http://www.vam.ac.uk/api/json/museumobject/"+e,isLoaded:"no"};i(o,t)},M=function(e,o){if(!museumApp.museumData.hasOwnProperty("data"))return!1;if(museumApp.museumData.data.hasOwnProperty(e)){var a=museumApp.museumData.data[e];return a.hasOwnProperty(o)?a[o]:!1}},v=function(e){if(e.VaM&&e.VaM().hasOwnProperty("place")){var o=e.VaM().place()[0];return o.records}return[]};return{getMusuemMarkerPlaces:v,requestMuseumPlaces:p,requestPlaceMusuemObjects:b,loadMorePlaceObjects:g,loadMorePlacesVisible:d,getmuseumObjectDetails:f,musuemDataIfExists:M,clearFilter:m,removePlacefromMusuemData:c,clearSelectedObjectPlace:n,clearSelectedMusuemObject:u,clearSelectedMusuemMarker:l,setThumbImagePath:t}}(t),s=function(){var e=function(){var e=[],o=[{lat:51.51942532808189,lng:-.391387939453125},{lat:51.61545844207286,lng:-.2190399169921875},{lat:51.64103302109062,lng:-.10162353515625},{lat:51.5954149508168,lng:.031585693359375},{lat:51.549751017014195,lng:.11260986328125},{lat:51.49121712928709,lng:.1318359375},{lat:51.42104840561726,lng:.0494384765625},{lat:51.40306101512005,lng:-.078277587890625},{lat:51.40777268236964,lng:-.22247314453125},{lat:51.47240196119371,lng:-.3714752197265625}],a=[{lat:51.520493477218274,lng:-.16736984252929688},{lat:51.535872047109315,lng:-.10969161987304688},{lat:51.53864817973768,lng:-.034503936767578125},{lat:51.50307952226442,lng:-.016651153564453125},{lat:51.4973090140083,lng:-.09304046630859375},{lat:51.47122575543907,lng:-.11707305908203125},{lat:51.4608524464555,lng:-.17526626586914062},{lat:51.47218810785753,lng:-.20788192749023438},{lat:51.4973090140083,lng:-.22212982177734375},{lat:51.51739577570338,lng:-.20341873168945312}],t=new google.maps.Polygon({paths:o,strokeColor:"#FF0000",strokeOpacity:.1,strokeWeight:2,fillColor:"#FF0000",fillOpacity:.1}),r=new google.maps.Polygon({paths:a,strokeColor:"blue",strokeOpacity:.1,strokeWeight:2,fillColor:"blue",fillOpacity:.1});return e.push({name:"londonArea",polygon:t}),e.push({name:"centralLondon",polygon:r}),e},r=function(e){k(e),a.obsSelectedMusuemMarker(e),M(e)},l=function(e){a.obsSelectedMusuemObjectPlace(e),t.requestPlaceMusuemObjects(e.pk,a.obsSelectedMusuemMarker())},n=function(e){var o=e.fields.object_number;t.getmuseumObjectDetails(o),h(e)},u=function(e,a){e.prefPlaceMarker.setMap(null),o.obsArrayMapMarkers.remove(e),t.removePlacefromMusuemData(e),void 0!==a&&a.stopImmediatePropagation()},i=function(){t.clearSelectedMusuemMarker(),m()},m=function(){var e=o.compFilterMapList().length;if(e>0){for(var a=new google.maps.LatLngBounds,t=o.compFilterMapList(),r=0;r<t.length;r++){var s=t[r].prefPlaceMarker;a.extend(s.getPosition())}o.googleMap.fitBounds(a)}},p=function(){var e=museumApp.museumData.data.place,o=0;for(var a in e){var t=e[a];d(t),o+=1}console.log("rebuild "+o+" markers from museumData"),m()},d=function(e){var o=w(e.googlePlace),a=e.resourceRefObj.modelCollection,t=e.museumData;c(a,t,o)},g=function(e){return{path:"M 0,0 C -2,-20 -10,-22 -10,-30 A 10,10 0 1,1 10,-30 C 10,-22 2,-20 0,0 z M -2,-30 a 2,2 0 1,1 4,0 2,2 0 1,1 -4,0",fillColor:e,fillOpacity:.75,strokeColor:"salmon",strokeWeight:3,scale:.9}},b=function(e){return{path:"M 0,0 C -2,-20 -10,-22 -10,-30 A 10,10 0 1,1 10,-30 C 10,-22 2,-20 0,0 z M -2,-30 a 2,2 0 1,1 4,0 2,2 0 1,1 -4,0",fillColor:e,fillOpacity:.75,strokeColor:"yellow",strokeWeight:4,scale:1}},f=function(){return{path:google.maps.SymbolPath.CIRCLE,fillColor:"salmon",fillOpacity:1,strokeColor:"yellow",strokeWeight:1,scale:4}},M=function(e){var o=e.prefPlaceMarker;o.setAnimation(google.maps.Animation.BOUNCE),setTimeout(function(){o.setAnimation(null)},1400)},v=function(){var e=o.obsUserLocalPlace();if(e){var r={lat:e.geoPosition.coords.latitude,lng:e.geoPosition.coords.longitude};a.obsSelectedMusuemMarker()&&t.clearSelectedMusuemMarker(),L(r)}},k=function(e){if(e.bestPlace.geometry.hasOwnProperty("bounds"))o.googleMap.fitBounds(e.bestPlace.geometry.bounds),o.googleMap.getZoom()>14&&o.googleMap.setZoom(14);else{o.googleMap.panTo(e.bestPlace.geometry.location);var a=o.googleMap.getZoom();11>a?o.googleMap.setZoom(12):o.googleMap.setZoom(a)}},h=function(){a.musemObjectWindow.open(o.googleMap,a.obsSelectedMusuemMarker().prefPlaceMarker),a.obsMusemObjectWindowVisible(!0)},P=function(e){a.musemObjectWindow.open(o.googleMap),a.musemObjectWindow.setContent(e)},y=function(e){var o="";if(e){var t=e.fields,r="";""!==t.label?r=t.label:""!==t.descriptive_line?r=t.descriptive_line:(""!==t.artist&&(r=t.artist),r+=" - "+t.object+", "+t.date_text),o+='<div class="ui card">',o+='<div class="ui segment">'+r+"</div>",o+=" </div>"}return a.musemObjectWindow.setContent(o),o},O=function(){a.musemObjectWindow.setContent(""),a.musemObjectWindow.close()},j=function(e){google.maps.setCenter(e)},S=function(){return o.googleMap.getCenter()},w=function(e){var r="",l=e.address_components[0].types[0];"street_number"===l?r=void 0!==e.address_components[1]?e.address_components[1].long_name:e.address_components[0].long_name:void 0!==e.address_components[1]&&(r=e.address_components[0].long_name);var n=4*r.length,u=new MarkerWithLabel({position:e.geometry.location,map:o.googleMap,icon:s.prefPlacePinOptions("gold"),id:e.place_id,draggable:!1,labelContent:r,labelAnchor:new google.maps.Point(n,0),labelClass:"place-labels",labelInBackground:!1,labelVisible:!0,visible:!0,animation:google.maps.Animation.DROP,zIndex:0}),i={VaM:ko.observable({}),prefPlaceMarker:u,bestPlace:e,obsMuseumMarkerListLabel:ko.observable(!1)};return u.addListener("click",function(){k(i),a.obsSelectedMusuemMarker()&&t.clearSelectedMusuemMarker(),a.obsSelectedMusuemMarker(i),M(i)}),o.obsArrayMapMarkers.push(i),i},L=function(e){e instanceof google.maps.LatLng||(e=new google.maps.LatLng(e.lat,e.lng)),o.geocoder.geocode({location:e,bounds:o.googleMap.bounds},function(r,s){if(s===google.maps.GeocoderStatus.OK){if(r){var l=function(e,a){for(var t=e.types,r=t.length,s=0;r>s;s++){var l=t[s],n=o.placeTypeInPrefOrder.indexOf(l);if(-1!==n)return!0}return!1},n=$.grep(r,l),u=5,i=!1;if(n.length>0){var c=C(e);c?("centralLondon"===c.name?u=.5:"londonArea"===c.name&&(u=2),i=r[0]):i=n[0]}else i=r[0];if("country"===i.types[0])return a.obsUIerrorHtml("Sorry can't find any places at this location"),!1;var m=A(i);if(m!==!1){if(""!==o.obsFilterSearch){var p=o.compFilterMapList().indexOf(m);-1===p&&t.clearFilter()}return k(m),a.obsSelectedMusuemMarker(m),M(m),!0}var d=w(i);return""!==o.obsFilterSearch&&t.clearFilter(),t.requestMuseumPlaces(d,u),!0}return a.obsUIerrorHtml("No place found at this location. Please try somewhere else on the map"),!1}return a.obsUIerrorHtml("Sorry can't find any places at this location"),!1})},C=function(e){var a=o.londonPolygonAreas[1],t=o.londonPolygonAreas[0];return a.polygon.containsLatLng(e)?a:t.polygon.containsLatLng(e)?t:!1},A=function(e){for(var a=o.obsArrayMapMarkers(),t=0;t<a.length;t++)if(a[t].bestPlace.place_id===e.place_id)return a[t];return!1};google.maps.Polygon.prototype.getBounds||(google.maps.Polygon.prototype.getBounds=function(e){var o,a,t,r=new google.maps.LatLngBounds,s=this.getPaths();for(a=0;a<s.getLength();a++)for(o=s.getAt(a),t=0;t<o.getLength();t++)r.extend(o.getAt(t));return r}),google.maps.Polygon.prototype.containsLatLng=function(e){var o,a,t,r,s,l,n,u,i,c,m,p=!1;if(2===arguments.length)"number"==typeof arguments[0]&&"number"==typeof arguments[1]&&(a=arguments[0],t=arguments[1]);else if(1===arguments.length){if(o=this.getBounds(),!o&&!o.contains(e))return!1;a=e.lat(),t=e.lng()}for(r=this.getPaths().getLength(),s=0;r>s;s++)for(l=this.getPaths().getAt(s),n=l.getLength(),i=n-1,u=0;n>u;u++)c=l.getAt(u),m=l.getAt(i),(c.lng()<t&&m.lng()>=t||m.lng()<t&&c.lng()>=t)&&c.lat()+(t-c.lng())/(m.lng()-c.lng())*(m.lat()-c.lat())<a&&(p=!p),i=u;return p};var _=function(){for(var e=o.googleMap.zoom>5,a=o.compFilterMapList(),t=0;t<a.length;t++)a[t].prefPlaceMarker.labelVisible=e},D=function(){var e=ko.utils.arrayFilter(o.compFilterMapList(),function(e){var a=o.googleMap.getBounds();return a.contains(e.prefPlaceMarker.getPosition())});return e},I=function(){var e=ko.utils.compareArrays(o.obsArrayMapMarkers(),o.compFilterMapList());ko.utils.arrayForEach(e,function(e){"deleted"===e.status?e.value.prefPlaceMarker.setVisible(!1):"retained"===e.status&&e.value.prefPlaceMarker.setVisible(!0)})},V=function(){I(),_()};return{makeLondonPolygons:e,markerListClick:r,removeMarker:u,showAllPlaces:i,zoomToAllPlaces:m,searchHere:L,centerMap:j,getMapCenter:S,inLondon:C,prefPlacePinOptions:g,selectedPlacePinOptions:b,musuemObjectPlacePinOptions:f,rebuildMarkersFromMusuemData:p,rebuildMarker:d,searchUsersLocation:v,panMapToMuseumMarker:k,mapMarkerExistsRef:A,openMuseumObjectWindow:h,openInfoBoxWithError:P,closeMuseumObjectWindow:O,markerLabelsDisplay:_,displayMarkersInBounds:D,filterMarkersOnMap:I,updateMapMarkerDisplay:V,objectPlaceListClick:l,objectListClick:n,updateMusemObjectInfoBoxContents:y}}(s),l=function(){if("geolocation"in navigator){var e={maximumAge:6e5,timeout:15e3},a=function(e){o.obsUserLocalPlace({geoPosition:e})},t=function(e){};navigator.geolocation.getCurrentPosition(a,t,e)}},n=function(){ko.bindingHandlers.mapPanel={init:function(e,r,l,n,u){var i=new google.maps.Map(e,{backgroundColor:"none",disableDoubleClickZoom:!0,mapTypeControl:!1,zoomControl:!0,zoomControlOptions:{position:google.maps.ControlPosition.RIGHT_CENTER},scaleControl:!0,mapTypeId:google.maps.MapTypeId.TERRAIN,center:new google.maps.LatLng(51.478771,-.011074),zoom:11});o.googleMap=i,o.geocoder=new google.maps.Geocoder(i),o.londonPolygonAreas=s.makeLondonPolygons(),i.addListener("bounds_changed",function(){s.markerLabelsDisplay()}),i.addListener("zoom_changed",function(){s.markerLabelsDisplay()}),google.maps.event.addListener(o.googleMap,"dblclick",function(e){t.clearFilter(),s.searchHere(e.latLng),a.obsHelpVisible(!1)}),google.maps.event.addDomListener(window,"resize",function(){var e=$(window).height()/2;$("#map").height(e);var a=o.googleMap.getCenter();o.googleMap.setCenter(a)})},update:function(e,o,a,t,r){}}},u=function(){o.obsArrayMapMarkers.subscribe(function(e){s.filterMarkersOnMap()},null,"change"),o.compFilterMapList.subscribe(function(e){s.filterMarkersOnMap(),s.zoomToAllPlaces()},null,"change"),a.obsSelectedMusuemMarker.subscribe(function(e){e&&e.prefPlaceMarker.setIcon(s.prefPlacePinOptions("gold"))},null,"beforeChange"),a.obsSelectedMusuemMarker.subscribe(function(e){if(e){var o=e.prefPlaceMarker.getPosition(),r=5,l=s.inLondon(o);if(e.prefPlaceMarker.setIcon(s.selectedPlacePinOptions("salmon")),e.VaM().hasOwnProperty("place")){var n=e.VaM().place()[0],u=n.meta.result_count;if(0===u)a.obsCurrentPlaceObjects(!1);else{var i=n.records.length;i===u?a.obsCurrentPlaceObjects(n.records):(l&&("centralLondon"===l.name?r=.5:"londonArea"===l.name&&(r=2)),t.requestMuseumPlaces(e,r,i))}}else l&&("centralLondon"===l.name?r=.5:"londonArea"===l.name&&(r=2)),t.requestMuseumPlaces(e,r)}else a.obsCurrentPlaceObjects(!1)},null,"change"),a.obsSelectedMusuemObject.subscribe(function(e){e!==!1&&s.updateMusemObjectInfoBoxContents(e)},null,"change"),a.obsUIerrorHtml.subscribe(function(e){var o=3e3,t=function(){clearTimeout(a.appUIWarnTimeOutID),a.obsUIerrorHtml(!1)};a.appUIWarnTimeOutID=setTimeout(t,o)},null,"change"),o.obsFilterSearch.subscribe(function(e){s.updateMapMarkerDisplay()},null,"change")};return n(),u(),l(),{uiModel:a,mapsModel:o,mapHelpers:s,museumDataHelpers:t}};return{museumViewModel:o,init:u,appFail:n,googleFail:a,initmuseumPlaces:t,localStorageP:r,museumData:e}}();window.googleSuccess=function(){"use strict";$.getScript("js/library/InfoBox.js").done(function(){$.getScript("js/library/MarkerWithLabel.js").done(function(){museumApp.init()}).fail(function(){"object"==typeof ko&&museumApp.appFail("MarkerWithLabel")})}).fail(function(){"object"==typeof ko&&museumApp.appFail("InfoBox")})},window.googleError=function(){"use strict";"object"==typeof ko&&museumApp.appFail("google maps")},$(document).ready(function(){"use strict";var e=$(window).height()/1.7;$("#map").height(e),$("#map").css("visibility","visible")});